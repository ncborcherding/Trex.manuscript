---
title: "C2.Analysis"
author: "Nick Borcherding"
date: "8/15/2021"
output: html_document
---

# Loading Data and Trex

```{r}
library(Trex)
library(stringr)
library(stringdist)
library(amap)
library(keras)

list <- readRDS("./data/Filteredintegrated_seuratObjects.rds")

###############################################################
#Filter for barcodes with only TCR 
#This is Built into runTrex(), just want to save some memory upfront
################################################################
cells.chains <- rownames(list[[]][!is.na(list[["cloneType"]]),])
list <- subset(list, cells = cells.chains)

rm(cells.chains)
```

# Running Trex

Here we are using: 
* Autoencoder model in Trex, specifically for the Atchley factors. 
* The relationship between sequences being called by nearest neighbor. Which will identify 40 nearest neighbors. If a clonal sequence has more than 40 cells with the TCR, this will automatically randomize the nearest neighbor call within the clonal cells.
* 50 dimenshions will be returned using the spectral transformation.


```{r}
list  <- runTrex(list, AA.method = "auto", 
                    AA.properties = "AF", 
                    nearest.method = "nn",
                    near.neighbor = 40,
                    n.dim = 50,
                    reduction.name = "Trex.AF")
saveRDS(list, file = "./data/Filteredintegrated_seuratObjects.rds")
```

## Examining Trex Dimensions 

One thing I found while building this package was the interesting differences between dimensions - the first several dimensions are clearly influenced by clone, however, as the dimensions increase a more continuous-like relationship emerges.

```{r}
dir.create("./output")
library(patchwork)
dims <- list(c(1,2), c(3,4), c(5,6), c(7,8), c(9,10), c(11,12), c(13,14), c(15,16), c(17,18))

for (i in seq_along(dims)) {
  plot <- DimPlot(list, dims = unlist(dims[i]), reduction = "Trex.AF", group.by = "CTaa") +
    scale_color_manual(values = viridis::viridis_pal(option = "B")(length(unique(list$CTaa)))) + 
    guides(color = "none") + 
    theme_void() + 
    theme(plot.title = element_blank())
  assign(paste0("Plot", i), plot)
}

Plot1 + Plot2 + Plot3 + Plot4 + Plot5 + Plot6 + Plot7 + Plot8  +  plot_layout(ncol = 4)
ggsave("./output/DimExamination.png", height = 6, width = 12, dpi = 600, bg = "transparent")
```

# Comparing the UMAP outputs from ADT vs RNA vs TCR

```{r}
list <- RunUMAP(list, reduction = 'pca', dims = 1:30, assay = 'integrated', 
              reduction.name = 'rna.umap', reduction.key = 'rnaUMAP_')

list <- RunUMAP(list, reduction = 'apca', dims = 1:20, assay = 'ADT.integrated', 
              reduction.name = 'adt.umap', reduction.key = 'adtUMAP_')

list <- RunUMAP(list, reduction = 'Trex.AF', dims = 1:50, 
              reduction.name = 'Trex.umap', reduction.key = 'trexUMAP_')
```

```{r}
pal <- viridis::viridis_pal(option = "H")(length(unique(list$Patient)))

plot10 <- DimPlot(list, reduction = "rna.umap", group.by = "Patient") +
   guides(color = "none") + 
  scale_color_manual(values = pal) +
  theme_void() + 
  theme(plot.title = element_blank())
plot11 <- DimPlot(list, reduction = "adt.umap", group.by = "Patient") +
   guides(color = "none") + 
  scale_color_manual(values = pal) +
  theme_void() + 
  theme(plot.title = element_blank())
plot12 <- DimPlot(list, reduction = "Trex.umap", group.by = "Patient") +
   guides(color = "none") + 
  scale_color_manual(values = pal) +
  theme_void() + 
  theme(plot.title = element_blank())

plot10 + plot11 + plot12

ggsave("./output/UMAPcompare_byPatient.png", height = 3, width = 9, dpi = 600, bg = "transparent")


list$cloneType <- factor(list$cloneType, 
                levels = c("Hyperexpanded (0.1 < X <= 1)", 
                           "Large (0.01 < X <= 0.1)", 
                            "Medium (0.001 < X <= 0.01)", 
                            "Small (1e-04 < X <= 0.001)", 
                            "Rare (0 < X <= 1e-04)", NA))

plot13 <- DimPlot(list, reduction = "rna.umap", group.by = "cloneType") +
   guides(color = "none") + 
  scale_color_manual(values = rev(viridis_pal(option = "B")(5))) +
  theme_void() + 
  theme(plot.title = element_blank())
plot14 <- DimPlot(list, reduction = "adt.umap", group.by = "cloneType") +
   guides(color = "none") + 
  scale_color_manual(values = rev(viridis_pal(option = "B")(5))) +
  theme_void() + 
  theme(plot.title = element_blank())
plot15 <- DimPlot(list, reduction = "Trex.umap", group.by = "cloneType") +
   guides(color = "none") + 
  scale_color_manual(values = rev(viridis_pal(option = "B")(5))) +
  theme_void() + 
  theme(plot.title = element_blank())

plot13 + plot14 + plot15
ggsave("./output/UMAPcompare_byClonotype.png", height = 3, width = 9, dpi = 600, bg = "transparent")
```

```{r}
seuratObj <- RunHarmony(list, "dataset")
seuratObj <- RunUMAP(seuratObj, reduction = "harmony")
```

## Calculating the multi-modal neighbor 

```{r}
list <- FindMultiModalNeighbors(
  list, reduction.list = list("pca", "apca", "Trex.AF"), 
  dims.list = list(1:30, 1:20, 1:50), modality.weight.name = "RNA.weight")

list <- RunUMAP(list, nn.name = "weighted.nn", 
                     reduction.name = "wnn.umap", reduction.key = "wnnUMAP_")
list <- FindClusters(list, graph.name = "wknn", algorithm = 3, resolution = 0.8, verbose = FALSE)


plot16 <- DimPlot(list, reduction = "wnn.umap",  label = TRUE) + NoLegend()
plot17 <- DimPlot(list, reduction = "wnn.umap", group.by = "CTaa") + scale_color_manual(values = viridis_pal(option = "B")(length(unique(list$CTaa)))) + NoLegend()
plot18 <- DimPlot(list, group.by = "cloneType", reduction = "wnn.umap") + scale_color_manual(values = rev(viridis_pal(option = "B")(5))) + NoLegend()

group_by()

```

# Nearest Neighbor Index between modalities
```{r}
list <- RunHarmony(list, reduction = "Trex.AF", group.by.vars = c("CTaa", "Patient"))
```

